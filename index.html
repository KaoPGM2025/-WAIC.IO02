<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Management AI v4.0.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-main: 'Kanit', sans-serif;
            --text-medium: 1.1rem;
        }
        body {
            font-family: var(--font-main);
            font-size: var(--text-medium);
            background-color: #f0f2f5;
        }
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 1.5rem;
        }
        .btn-primary {
            background: #2563eb;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .btn-primary:hover { background: #1d4ed8; }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-weight: 500;
        }
        .timer-badge {
            font-size: 0.85rem;
            color: #ef4444;
            font-weight: bold;
        }
        input, select {
            font-size: 1rem;
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            border-radius: 6px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Smart Finance v4.0.0</h1>
                <p class="text-gray-500">ระบบจัดการการเงินอัจฉริยะ (AI Powered)</p>
            </div>
            <div id="overall-status" class="card py-2 px-6 border-l-4 border-blue-500">
                <span class="text-sm text-gray-500">สถานะทางการเงิน:</span>
                <div id="status-text" class="font-bold text-lg text-blue-600">กำลังประมวลผล...</div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Summary & Target -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Summary Card -->
                <div class="card bg-gradient-to-br from-blue-600 to-blue-800 text-white">
                    <h2 class="text-lg opacity-90">ยอดเงินคงเหลือทั้งหมด</h2>
                    <div id="total-balance" class="text-4xl font-bold my-2">฿0.00</div>
                    <div class="flex justify-between mt-4 text-sm">
                        <span>รายรับ: <span id="total-income">฿0</span></span>
                        <span>รายจ่าย: <span id="total-expense">฿0</span></span>
                    </div>
                </div>

                <!-- Savings Goal Card -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">เป้าหมายการออม</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-500">เป้าหมาย (บาท)</label>
                            <input type="number" id="goal-amount" class="w-full mt-1" placeholder="ระบุจำนวนเงิน" onchange="updateGoal()">
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <div class="flex justify-between mb-1">
                                <span class="text-sm">ความคืบหน้า</span>
                                <span id="goal-percent" class="text-sm font-bold text-blue-600">0%</span>
                            </div>
                            <div class="w-full bg-gray-300 rounded-full h-2.5">
                                <div id="goal-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Card -->
                <div class="card border-2 border-purple-200">
                    <h2 class="text-xl font-semibold mb-2 text-purple-700 flex items-center">
                        <span class="mr-2">✨</span> AI วิเคราะห์
                    </h2>
                    <div id="ai-insight" class="text-gray-600 italic">
                        "รอการบันทึกข้อมูลเพื่อวิเคราะห์ความเหมาะสมทางการเงิน..."
                    </div>
                </div>
            </div>

            <!-- Middle/Right Column: Input & Graph -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Transaction Form -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">บันทึกธุรกรรม</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="desc" placeholder="รายการ (เช่น เงินเดือน, ค่าข้าว)" class="md:col-span-1">
                        <input type="number" id="amount" placeholder="จำนวนเงิน" class="md:col-span-1">
                        <select id="type" class="md:col-span-1">
                            <option value="income">รายรับ (+)</option>
                            <option value="expense">รายจ่าย (-)</option>
                        </select>
                        <button onclick="addTransaction()" class="btn-primary">บันทึกอัตโนมัติ</button>
                    </div>
                </div>

                <!-- Graph -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">กราฟวิเคราะห์แนวโน้ม</h2>
                    <div class="chart-container">
                        <canvas id="financeChart"></canvas>
                    </div>
                </div>

                <!-- History -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">ประวัติธุรกรรมล่าสุด</h2>
                        <span class="text-xs text-gray-400 font-normal">*รายการจะแสดงในหน้านี้เพียง 60 วินาทีเพื่อความปลอดภัย</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3">เวลา</th>
                                    <th class="p-3">รายการ</th>
                                    <th class="p-3">จำนวน</th>
                                    <th class="p-3 text-right">หมดอายุใน</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-list">
                                <!-- Data will appear here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data Structure & State
        let state = JSON.parse(localStorage.getItem('finance_data_v4')) || {
            transactions: [], // ฐานข้อมูลหลัก (ห้ามหาย)
            goal: 0,
            totalIncome: 0,
            totalExpense: 0,
            balance: 0
        };

        // สำหรับรายการที่กำลังนับถอยหลังลบจากหน้าจอ
        let temporaryHistory = [];
        let financeChart;

        // Initialize App
        window.onload = function() {
            initChart();
            renderAll();
            checkHistoryTimers(); // ตรวจสอบเวลาที่เหลือหากโหลดหน้าใหม่
        };

        function saveData() {
            localStorage.setItem('finance_data_v4', JSON.stringify(state));
            updateAI();
        }

        function addTransaction() {
            const desc = document.getElementById('desc').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('type').value;

            if (!desc || isNaN(amount)) return;

            const newEntry = {
                id: Date.now(),
                desc,
                amount,
                type,
                timestamp: new Date().toLocaleTimeString(),
                createdAt: Date.now()
            };

            // บันทึกลงฐานข้อมูลถาวร
            state.transactions.push(newEntry);
            if (type === 'income') {
                state.balance += amount;
                state.totalIncome += amount;
            } else {
                state.balance -= amount;
                state.totalExpense += amount;
            }

            // เพิ่มลงในคิวแสดงผลชั่วคราว (1 นาที)
            temporaryHistory.push({
                ...newEntry,
                expiry: Date.now() + 60000
            });

            saveData();
            renderAll();
            
            // Clear inputs
            document.getElementById('desc').value = '';
            document.getElementById('amount').value = '';
        }

        function updateGoal() {
            state.goal = parseFloat(document.getElementById('goal-amount').value) || 0;
            saveData();
            renderAll();
        }

        function renderAll() {
            // Update Summary
            document.getElementById('total-balance').innerText = `฿${state.balance.toLocaleString()}`;
            document.getElementById('total-income').innerText = `฿${state.totalIncome.toLocaleString()}`;
            document.getElementById('total-expense').innerText = `฿${state.totalExpense.toLocaleString()}`;
            document.getElementById('goal-amount').value = state.goal;

            // Update Progress Bar
            const percent = state.goal > 0 ? Math.min((state.balance / state.goal) * 100, 100) : 0;
            document.getElementById('goal-percent').innerText = `${percent.toFixed(1)}%`;
            document.getElementById('goal-bar').style.width = `${percent}%`;

            // Update Status Badge
            const statusEl = document.getElementById('status-text');
            if (state.balance > state.goal && state.goal > 0) {
                statusEl.innerText = 'มั่งคั่ง (บรรลุเป้าหมาย)';
                statusEl.className = 'font-bold text-lg text-green-600';
            } else if (state.balance > 0) {
                statusEl.innerText = 'ปกติ';
                statusEl.className = 'font-bold text-lg text-blue-600';
            } else {
                statusEl.innerText = 'ควรระวัง';
                statusEl.className = 'font-bold text-lg text-red-600';
            }

            updateTable();
            updateChart();
            updateAI();
        }

        function updateTable() {
            const list = document.getElementById('transaction-list');
            list.innerHTML = '';

            temporaryHistory.forEach((item, index) => {
                const timeLeft = Math.max(0, Math.ceil((item.expiry - Date.now()) / 1000));
                
                if (timeLeft > 0) {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50 transition';
                    row.innerHTML = `
                        <td class="p-3 text-sm text-gray-500">${item.timestamp}</td>
                        <td class="p-3 font-medium">${item.desc}</td>
                        <td class="p-3 ${item.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                            ${item.type === 'income' ? '+' : '-'}฿${item.amount.toLocaleString()}
                        </td>
                        <td class="p-3 text-right">
                            <span class="timer-badge">${timeLeft} วินาที</span>
                        </td>
                    `;
                    list.appendChild(row);
                }
            });
        }

        // ระบบจับเวลาลบประวัติล่าสุด (ไม่กระทบข้อมูลหลัก)
        setInterval(() => {
            const originalLength = temporaryHistory.length;
            temporaryHistory = temporaryHistory.filter(item => item.expiry > Date.now());
            if (temporaryHistory.length !== originalLength) {
                updateTable();
            } else if (temporaryHistory.length > 0) {
                updateTable(); // Update countdown numbers
            }
        }, 1000);

        function checkHistoryTimers() {
            // เมื่อรีโหลดหน้าจอ ให้ดึงรายการล่าสุดจาก transactions หลักที่อายุไม่เกิน 1 นาทีมาแสดงใหม่
            const now = Date.now();
            temporaryHistory = state.transactions
                .filter(t => (now - t.createdAt) < 60000)
                .map(t => ({ ...t, expiry: t.createdAt + 60000 }));
        }

        function initChart() {
            const ctx = document.getElementById('financeChart').getContext('2d');
            financeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ยอดเงินสุทธิ',
                        data: [],
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
        }

        function updateChart() {
            if (!financeChart) return;
            
            // คำนวณหาจุดของกราฟจากประวัติ
            let runningBalance = 0;
            const labels = [];
            const data = [];

            state.transactions.slice(-10).forEach(t => {
                labels.push(t.timestamp);
                if (t.type === 'income') runningBalance += t.amount;
                else runningBalance -= t.amount;
                data.push(runningBalance);
            });

            financeChart.data.labels = labels;
            financeChart.data.datasets[0].data = data;
            financeChart.update();
        }

        function updateAI() {
            const aiBox = document.getElementById('ai-insight');
            if (state.transactions.length === 0) {
                aiBox.innerText = "รอการบันทึกข้อมูลเพื่อวิเคราะห์ความเหมาะสมทางการเงิน...";
                aiBox.className = "text-gray-500 italic";
                return;
            }

            const incomeRatio = state.totalIncome > 0 ? (state.totalExpense / state.totalIncome) * 100 : 0;
            let advice = "";

            if (incomeRatio > 80) {
                advice = "⚠️ AI ตรวจพบว่ารายจ่ายของคุณสูงถึง " + incomeRatio.toFixed(0) + "% ของรายได้ แนะนำให้ลดค่าใช้จ่ายที่ไม่จำเป็นเพื่อความปลอดภัย";
            } else if (incomeRatio < 40) {
                advice = "✅ ยอดเยี่ยม! คุณมีการจัดการเงินที่ดีมาก มีสัดส่วนรายจ่ายที่ต่ำ แนะนำให้ออมเพิ่มหรือลงทุน";
            } else {
                advice = "⚖️ สถานะทางการเงินอยู่ในเกณฑ์ปกติ พยายามรักษาพอร์ตรายรับรายจ่ายแบบนี้ต่อไป";
            }

            if (state.goal > 0 && state.balance < (state.goal * 0.2)) {
                advice += " และคุณยังห่างจากเป้าหมายการออมพอสมควร สู้ๆ ครับ!";
            }

            aiBox.innerText = advice;
            aiBox.className = "text-purple-800 font-medium";
        }
    </script>
</body>
</html>
